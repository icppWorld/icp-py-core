name: Release

on:
  push:
    tags:
      - 'v*' # Trigger only on tags (e.g., v0.1.0)

jobs:
  build_wheels_linux_windows:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        # ABI3 wheels only need to be built once per platform
        include:
          - os: ubuntu-latest
            python: '3.10'  # 只需要指定一个版本即可构建 abi3 wheel
          - os: windows-latest
            python: '3.10'
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}
          
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          # maturin-action automatically uses the Python from setup-python
          # Key parameters:
          # --release: Enable compiler optimizations
          # --strip: Remove symbol table to reduce size
          # --find-interpreter: Find Python interpreter automatically
          args: --release --strip --out dist --find-interpreter
          sccache: 'true'
          # manylinux: auto automatically builds packages compatible with older Linux (CentOS 7/Ubuntu 18.04)
          manylinux: auto 
          working-directory: src/icp_candid/ic_candid_parser
          
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          # 修改 artifact 名字，去掉 python 版本号，避免混淆
          name: wheels-${{ matrix.os }}
          path: src/icp_candid/ic_candid_parser/dist

  build_wheels_macos:
    name: Build wheels on macOS (${{ matrix.target }})
    runs-on: macos-latest
    strategy:
      matrix:
        # Build for both Intel (x86_64) and Apple Silicon (aarch64) architectures
        # ABI3 wheels only need to be built once per architecture
        target: [x86_64-apple-darwin, aarch64-apple-darwin]
        # 不需要 python 列表，硬编码一个版本即可
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          # maturin-action automatically uses the Python from setup-python
          # Key parameters:
          # --release: Enable compiler optimizations
          # --strip: Remove symbol table to reduce size
          # --find-interpreter: Find Python interpreter automatically
          args: --release --strip --out dist --find-interpreter
          sccache: 'true'
          working-directory: src/icp_candid/ic_candid_parser
          
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          # Artifact 名字只区分 target
          name: wheels-macos-${{ matrix.target }}
          path: src/icp_candid/ic_candid_parser/dist

  # Build source distribution as fallback (for non-mainstream platforms that can compile from source)
  build_sdist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build sdist
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist
          working-directory: src/icp_candid/ic_candid_parser
      - uses: actions/upload-artifact@v4
        with:
          name: wheels-sdist
          path: src/icp_candid/ic_candid_parser/dist

  # Build main package wheels (Python package that depends on Rust extension)
  # Note: Since the main package is pure Python (py3-none-any), we only need to build once
  build_main_package:
    name: Build main package wheel
    runs-on: ubuntu-latest
    needs: [build_wheels_linux_windows, build_wheels_macos, build_sdist]
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Download Rust extension wheels
        uses: actions/download-artifact@v4
        with:
          # Download all wheels (will filter by OS and Python version when installing)
          pattern: wheels-*
          path: rust_wheels
          merge-multiple: true
      
      - name: Install Rust extension wheel
        # 强制使用 bash，以便在 Windows 上也能支持 << 'EOF' 语法
        shell: bash
        run: |
          python -m pip install --upgrade pip
          python << 'EOF'
          import os
          import glob
          import sys
          import platform
          
          wheels_dir = "rust_wheels"
          
          # Find all wheel files
          wheel_pattern = os.path.join(wheels_dir, "*.whl")
          all_wheels = glob.glob(wheel_pattern)
          
          if not all_wheels:
              print(f"Error: No wheel files found in {wheels_dir}")
              sys.exit(1)
          
          print(f"Found {len(all_wheels)} wheel files")
          
          # For Linux (ubuntu-latest), use manylinux wheels
          compatible_wheels = []
          for wheel in all_wheels:
              wheel_name = os.path.basename(wheel)
              if "manylinux" in wheel_name and "win" not in wheel_name and "darwin" not in wheel_name:
                  if "cp38-abi3" in wheel_name or "cp310" in wheel_name:
                      compatible_wheels.append(wheel)
          
          if not compatible_wheels:
              print(f"Error: No compatible wheel found for Linux")
              print("Available wheels:")
              for wheel in sorted(all_wheels):
                  print(f"  - {os.path.basename(wheel)}")
              sys.exit(1)
          
          # Use the first compatible wheel
          selected_wheel = compatible_wheels[0]
          print(f"Installing wheel: {os.path.basename(selected_wheel)}")
          
          # Install the wheel
          import subprocess
          result = subprocess.run([sys.executable, "-m", "pip", "install", selected_wheel], 
                                capture_output=True, text=True)
          if result.returncode != 0:
              print(f"Error installing wheel: {result.stderr}")
              sys.exit(1)
          print("Wheel installed successfully")
          EOF
      
      - name: Install build tools
        run: |
          pip install build wheel
      
      - name: Build main package wheel
        run: |
          python -m build --wheel
      
      - name: Upload main package wheel
        uses: actions/upload-artifact@v4
        with:
          name: main-package-wheel
          path: dist/*.whl

  # Build main package sdist
  build_main_sdist:
    name: Build main package sdist
    runs-on: ubuntu-latest
    needs: [build_wheels_linux_windows, build_wheels_macos, build_sdist]
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build
      
      - name: Build main package sdist
        run: |
          python -m build --sdist
      
      - name: Upload main package sdist
        uses: actions/upload-artifact@v4
        with:
          name: main-package-sdist
          path: dist/*.tar.gz

  # Publish Rust extension to PyPI first
  publish_rust_extension:
    name: Publish Rust Extension to PyPI
    runs-on: ubuntu-latest
    needs: [build_wheels_linux_windows, build_wheels_macos, build_sdist]
    environment: pypi
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true
      
      - name: List packages to publish
        run: |
          echo "Packages to publish:"
          ls -lh dist/
          echo ""
          echo "Package metadata check:"
          for pkg in dist/*.whl dist/*.tar.gz; do
            if [ -f "$pkg" ]; then
              echo "Checking: $pkg"
              python -m twine check "$pkg" || true
            fi
          done
      
      - name: Publish ic-candid-parser to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist
          verbose: true
          skip-existing: true

  # Publish main package to PyPI (depends on Rust extension being published)
  publish_main_package:
    name: Publish Main Package to PyPI
    runs-on: ubuntu-latest
    needs: [build_main_package, build_main_sdist, publish_rust_extension]
    environment: pypi
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Download main package artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: main-package-*
          path: dist
          merge-multiple: true
      
      - name: Install twine for validation
        run: |
          pip install twine
      
      - name: Validate packages before publishing
        run: |
          echo "Validating packages in dist directory..."
          ls -lh dist/
          echo ""
          
          # Check each package file
          for pkg in dist/*.whl dist/*.tar.gz; do
            if [ -f "$pkg" ]; then
              echo "Validating: $(basename $pkg)"
              if python -m twine check "$pkg"; then
                echo "✓ $(basename $pkg) is valid"
              else
                echo "✗ $(basename $pkg) is invalid or corrupted"
                echo "Removing invalid file..."
                rm -f "$pkg"
              fi
              echo ""
            fi
          done
          
          echo "Final packages to publish:"
          ls -lh dist/
          
          # Ensure at least one valid package exists
          if [ -z "$(ls -A dist/*.whl dist/*.tar.gz 2>/dev/null)" ]; then
            echo "Error: No valid packages found after validation"
            exit 1
          fi
      
      - name: Publish icp-py-core to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist
          skip-existing: true
          verify-metadata: true